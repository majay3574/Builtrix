pipeline {
    agent any

    tools {
        nodejs 'NODE JS'   // Must match exact NodeJS tool name
    }

    environment {
        CI = 'true'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Check Node & npm') {
            steps {
                script {
                    bat 'node -v'
                    bat 'npm -v'
                }
            }
        }

        stage('Install dependencies') {
            steps {
                script {
                    echo 'Installing npm dependencies...'
                    bat 'npm ci'
                }
            }
        }

        stage('Install Playwright browsers') {
            steps {
                script {
                    echo 'Installing Playwright browsers...'
                    bat 'npx playwright install --with-deps'
                }
            }
        }

        stage('Run Playwright tests') {
            steps {
                script {
                    echo 'Running Playwright tests...'
                    bat 'npx playwright test TC001_create_account.spec.ts'
                }
            }
        }

        stage('Publish Report') {
            steps {
                script {
                    echo 'Archiving Playwright HTML report...'
                    archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true
                }
            }
        }

        stage('Zip Report') {
            steps {
                script {
                    echo 'Zipping Playwright report...'
                    bat '''
                        powershell Compress-Archive `
                        -Path playwright-report/* `
                        -DestinationPath playwright-report.zip `
                        -Force
                    '''
                }
            }
        }

        stage('Send Email') {
            steps {
                script {
                    echo 'Sending Playwright report via email...'
                    emailext(
                        subject: 'Playwright Test Report',
                        body: '''Hi,
                        Please find the attached Playwright test report.

                        Regards,
                        Jenkins''',
                        to: 'majay357@gmail.com',
                        attachmentsPattern: 'playwright-report.zip'
                    )
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution completed.'
        }
        failure {
            echo '❌ Pipeline failed! Check logs for errors.'
        }
        success {
            echo '✅ All tests passed successfully!'
        }
    }
}
