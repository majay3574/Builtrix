pipeline {
    agent any

    tools {
        nodejs 'NODE JS'
    }

    environment {
        CI = 'true'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Check Node & npm') {
            steps {
                script {
                    bat 'node -v'
                    bat 'npm -v'
                }
            }
        }

        stage('Install dependencies') {
            steps {
                script {
                    echo 'Installing npm dependencies...'
                    bat 'npm ci'
                }
            }
        }

        stage('Install Playwright browsers') {
            steps {
                script {
                    echo 'Installing Playwright browsers...'
                    bat 'npx playwright install --with-deps'
                }
            }
        }

        stage('Run Playwright tests') {
            steps {
                script {
                    echo 'Running Playwright tests...'
                    def result = bat(script: 'npx playwright test TC004', returnStatus: true)
                    if (result != 0) {
                        currentBuild.result = 'UNSTABLE'
                        echo 'Some tests failed, but continuing pipeline...'
                    }
                }
            }
        }

        stage('Publish Report') {
            steps {
                script {
                    echo 'Archiving Playwright HTML report...'
                    archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true
                }
            }
        }

        stage('Zip Report') {
            steps {
                script {
                    echo 'Zipping Playwright report...'
                    bat 'powershell -Command "Compress-Archive -Path \'playwright-report\\*\' -DestinationPath \'playwright-report.zip\' -Force"'
                }
            }
        }

        stage('Send Email') {
            steps {
                script {
                    echo 'Sending Playwright report via email...'
                    emailext(
    subject: 'Playwright Report',
    body: 'Test email',
    to: 'nishanishaahsin96@gmail.com',
    attachmentsPattern: 'test-results.txt',
    debug: true
)
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution completed.'
        }
        failure {
            echo '❌ Pipeline failed! Check logs for errors.'
        }
        success {
            echo '✅ All tests passed successfully!'
        }
    }
}
