/**
 * Jenkins Pipeline for Playwright Test Automation
 * - Runs tests using Node.js
 * - Generates and publishes test reports
 * - Sends email notifications
 */
pipeline {
    // Pipeline Configuration
    agent any

    // Required Tools
    tools {
        nodejs 'NODE JS'
    }

    // Global Environment Variables
    environment {
        CI = 'true'
    }

    // Pipeline Stages
    stages {
        // Source Control
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        // Environment Setup Stages
        stage('Check Node & npm') {
            steps {
                script {
                    bat 'node -v'
                    bat 'npm -v'
                }
            }
        }

        stage('Install dependencies') {
            steps {
                script {
                    echo 'Installing npm dependencies...'
                    bat 'npm ci'
                }
            }
        }

        stage('Install Playwright browsers') {
            steps {
                script {
                    echo 'Installing Playwright browsers...'
                    bat 'npx playwright install --with-deps'
                }
            }
        }

        // Test Execution Stage
        stage('Run Playwright tests') {
            steps {
                script {
                    echo 'Running Playwright tests...'
                    def result = bat(script: 'npx playwright test TC004', returnStatus: true)
                    if (result != 0) {
                        currentBuild.result = 'UNSTABLE'
                        echo 'Some tests failed, but continuing pipeline...'
                    }
                }
            }
        }

        // Report Generation and Publishing Stages
        stage('Publish Report') {
            steps {
                script {
                    echo 'Archiving Playwright HTML report...'
                    archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true
                }
            }
        }

        stage('Zip Report') {
            steps {
                script {
                    echo 'Zipping Playwright report...'
                    bat 'powershell -Command "Compress-Archive -Path \'playwright-report\\*\' -DestinationPath \'playwright-report.zip\' -Force"'
                }
            }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML(target: [
                    reportDir: 'playwright-report',       // Report directory
                    reportFiles: 'index.html',           // Main report file
                    reportName: 'Playwright Test Report', // Display name
                    keepAll: true,                       // Retain all reports
                    alwaysLinkToLastBuild: true,         // Link to latest
                    allowMissing: false                  // Fail if missing
                ])
            }
        }

        // Notification Stage
        stage('Send Email') {
            steps {
                script {
                    echo 'Sending Playwright report via email...'
                    emailext(
                        subject: 'Playwright Report',
                        body: 'Test email',
                        to: 'nishanishaahsin96@gmail.com',
                        attachmentsPattern: 'test-results.txt',
                        debug: true
                    )
                }
            }
        }
    }

    // Post-Build Actions
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        failure {
            echo '❌ Pipeline failed! Check logs for errors.'
        }
        success {
            echo '✅ All tests passed successfully!'
        }
    }
}
